<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8" />
	<title>Qu·∫£n l√Ω c√¢u h·ªèi tr·∫Øc nghi·ªám</title>
	<link rel="stylesheet" href="css/styles_question.css" />
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6">
	</script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
	</script>
</head>

<body>
	<h1>Nh·∫≠p c√¢u h·ªèi tr·∫Øc nghi·ªám</h1>
	<form action="save_question.php" method="POST" enctype="multipart/form-data" id="questionForm">
		<div class="container">
			<div class="left-column">
				<label for="question">C√¢u h·ªèi:</label>
				<textarea id="question" name="question" rows="3" oninput="previewMath()"></textarea>

				<label for="answer1">ƒê√°p √°n A:</label>
				<input type="text" name="answer1" required />

				<label for="answer2">ƒê√°p √°n B:</label>
				<input type="text" name="answer2" required />

				<label for="answer3">ƒê√°p √°n C:</label>
				<input type="text" name="answer3" />

				<label for="answer4">ƒê√°p √°n D:</label>
				<input type="text" name="answer4" />

				<label for="correct_answer">ƒê√°p √°n ƒë√∫ng:</label>
				<select name="correct_answer" id="correct_answer" required>
					<option value="">-- Ch·ªçn ƒë√°p √°n ƒë√∫ng --</option>
					<option value="answer1">A</option>
					<option value="answer2">B</option>
					<option value="answer3">C</option>
					<option value="answer4">D</option>
				</select>

				<label for="image">·∫¢nh minh h·ªça (n·∫øu c√≥):</label>
				<input type="file" name="image" id="image" accept="image/*" />
				<img id="imagePreview" src="#" alt="Xem tr∆∞·ªõc ·∫£nh" />
			</div>


			<div class="right-column">
				<button type="submit">üíæ L∆∞u</button>
				<button type="button">‚ûï Th√™m m·ªõi</button>
				<button type="button" onclick="deleteSelected()">üóëÔ∏è Xo√°</button>
				<button type="button">‚úèÔ∏è S·ª≠a</button>
				<button type="button">üîç T√¨m ki·∫øm</button>
				<button type="button" onclick="syncTable()">üîÑ Hi·ªÉn th·ªã</button>
			</div>
		</div>
	</form>

	<div id="preview"></div>

	<!-- Danh s√°ch c√¢u h·ªèi -->
	<h2>C√°c c√¢u h·ªèi ƒë√£ l∆∞u</h2>
	<div style="max-width: 1000px; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px;">
		<iframe id="questionTable" src="get_question.php" style="width: 100%; height: 100%; border: none;"></iframe>
	</div>

	<!-- Script x·ª≠ l√Ω MathJax & Xem ·∫£nh -->
	<script>
		const questionInput = document.getElementById('question');
		const preview = document.getElementById('preview');

		questionInput.addEventListener('input', () => {
			preview.innerHTML = questionInput.value;
			MathJax.typesetPromise([preview]);
		});

		const imageInput = document.getElementById('image');
		const imagePreview = document.getElementById('imagePreview');

		imageInput.addEventListener('change', function () {
			if (this.files && this.files[0]) {
				const reader = new FileReader();
				reader.onload = function (e) {
					imagePreview.src = e.target.result;
					imagePreview.style.display = 'block';
				};
				reader.readAsDataURL(this.files[0]);
			} else {
				imagePreview.style.display = 'none';
				imagePreview.src = '';
			}
		});
	</script>
	<script>
		const form = document.getElementById('questionForm');
		const iframe = document.getElementById('questionTable');

		form.addEventListener('submit', function (e) {
			e.preventDefault(); // NgƒÉn submit truy·ªÅn th·ªëng

			const formData = new FormData(form);

			fetch('save_question.php', {
				method: 'POST',
				body: formData
			})
				.then(response => response.text())
				.then(result => {
					alert(result); // Hi·ªÉn th·ªã k·∫øt qu·∫£

					// Reset form
					form.reset();
					document.getElementById('imagePreview').style.display = 'none';
					document.getElementById('preview').innerHTML = '';

					// L√†m m·ªõi b·∫£ng
					iframe.contentWindow.location.reload();
				})
				.catch(error => {
					alert('L·ªói khi g·ª≠i d·ªØ li·ªáu!');
					console.error('Error:', error);
				});
		});
	</script>
	
	<script>
		function syncTable() {
			const iframe = document.getElementById('questionTable');
			iframe.contentWindow.location.reload();         // Reload iframe
			iframe.scrollIntoView({ behavior: 'smooth' });  // ƒê∆∞a con tr·ªè l√™n ƒë·∫ßu
		}
	</script>

	<script>
		window.addEventListener('message', function (event) {
			const data = event.data;

			if (data && typeof data === 'object') {
				document.getElementById('question').value = data.question || '';
				document.querySelector('[name="answer1"]').value = data.answer1 || '';
				document.querySelector('[name="answer2"]').value = data.answer2 || '';
				document.querySelector('[name="answer3"]').value = data.answer3 || '';
				document.querySelector('[name="answer4"]').value = data.answer4 || '';
				document.querySelector('[name="correct_answer"]').value = data.correct_answer || '';

				// Hi·ªÉn th·ªã ·∫£nh n·∫øu c√≥
				const imgPreview = document.getElementById('imagePreview');
				if (data.image) {
					imgPreview.src = data.image;
					imgPreview.style.display = 'block';
				} else {
					imgPreview.style.display = 'none';
				}

				// Hi·ªÉn th·ªã c√¥ng th·ª©c n·∫øu c√≥
				document.getElementById('preview').innerHTML = data.question || '';
				MathJax.typesetPromise([document.getElementById('preview')]);
			}
		});
	</script>

	<script>
		function deleteSelected() {
			if (!selectedQuestionId) {
				alert("Vui l√≤ng ch·ªçn m·ªôt d√≤ng ƒë·ªÉ xo√°.");
				return;
			}

			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° c√¢u h·ªèi n√†y?")) return;

			fetch(`delete_question.php?id=${selectedQuestionId}`, {
				method: 'GET'
			})
				.then(response => response.text())
				.then(result => {
					alert(result);
					selectedQuestionId = null;
					document.getElementById('questionForm').reset();
					document.getElementById('preview').innerHTML = '';
					document.getElementById('imagePreview').style.display = 'none';
					document.getElementById('questionTable').contentWindow.location.reload();
				})
				.catch(err => {
					alert("Xo√° th·∫•t b·∫°i!");
					console.error(err);
				});
		}

	</script>

	<script>
		function updateQuestion() {
			if (!selectedQuestionId) {
				alert("Vui l√≤ng ch·ªçn c√¢u h·ªèi ƒë·ªÉ s·ª≠a.");
				return;
			}

			const form = document.getElementById('questionForm');
			const formData = new FormData(form);
			formData.append('id', selectedQuestionId); // G·ª≠i ID ƒë·ªÉ c·∫≠p nh·∫≠t

			fetch('update_question.php', {
				method: 'POST',
				body: formData
			})
				.then(response => response.text())
				.then(result => {
					alert(result);
					document.getElementById('questionForm').reset();
					document.getElementById('imagePreview').style.display = 'none';
					document.getElementById('preview').innerHTML = '';
					document.getElementById('questionTable').contentWindow.location.reload();
					selectedQuestionId = null;
				})
				.catch(error => {
					alert('L·ªói khi c·∫≠p nh·∫≠t!');
					console.error(error);
				});
		}

		// G·∫Øn s·ª± ki·ªán cho n√∫t S·ª≠a
		document.querySelector('button:contains("‚úèÔ∏è S·ª≠a")')?.addEventListener('click', updateQuestion);
	</script>

</body>

</html>