<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8" />
	<title>Quản lý câu hỏi trắc nghiệm</title>
	<link rel="stylesheet" href="style.css" />
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6">
	</script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
	</script>
</head>

<body>
	<h1>Nhập câu hỏi trắc nghiệm</h1>

	<form action="save_question.php" method="POST" enctype="multipart/form-data" id="questionForm">
		<div class="container">
			<div class="left-column">
				<label for="question">Câu hỏi:</label>
				<textarea id="question" name="question" rows="3" oninput="previewMath()"></textarea>

				<label for="answer1">Đáp án A:</label>
				<input type="text" name="answer1" required />

				<label for="answer2">Đáp án B:</label>
				<input type="text" name="answer2" required />

				<label for="answer3">Đáp án C:</label>
				<input type="text" name="answer3" />

				<label for="answer4">Đáp án D:</label>
				<input type="text" name="answer4" />

				<label for="correct_answer">Đáp án đúng:</label>
				<select name="correct_answer" id="correct_answer" required>
					<option value="">-- Chọn đáp án đúng --</option>
					<option value="answer1">A</option>
					<option value="answer2">B</option>
					<option value="answer3">C</option>
					<option value="answer4">D</option>
				</select>

				<label for="image">Ảnh minh họa (nếu có):</label>
				<input type="file" name="image" id="image" accept="image/*" />
				<img id="imagePreview" src="#" alt="Xem trước ảnh" />
			</div>


			<div class="right-column">
				<button type="submit">💾 Lưu</button>
				<button type="button">➕ Thêm mới</button>
				<button type="button">🗑️ Xoá</button>
				<button type="button">✏️ Sửa</button>
				<button type="button">🔍 Tìm kiếm</button>
				<button type="button" onclick="syncTable()">🔄 Hiển thị</button>
			</div>
		</div>
	</form>

	<div id="preview"></div>

	<!-- Danh sách câu hỏi -->
	<h2>Các câu hỏi đã lưu</h2>
	<div style="max-width: 1000px; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px;">
		<iframe id="questionTable" src="get_question.php" style="width: 100%; height: 100%; border: none;"></iframe>
	</div>

	<!-- Script xử lý MathJax & Xem ảnh -->
	<script>
		const questionInput = document.getElementById('question');
		const preview = document.getElementById('preview');

		questionInput.addEventListener('input', () => {
			preview.innerHTML = questionInput.value;
			MathJax.typesetPromise([preview]);
		});

		const imageInput = document.getElementById('image');
		const imagePreview = document.getElementById('imagePreview');

		imageInput.addEventListener('change', function () {
			if (this.files && this.files[0]) {
				const reader = new FileReader();
				reader.onload = function (e) {
					imagePreview.src = e.target.result;
					imagePreview.style.display = 'block';
				};
				reader.readAsDataURL(this.files[0]);
			} else {
				imagePreview.style.display = 'none';
				imagePreview.src = '';
			}
		});
	</script>
	<script>
		const form = document.getElementById('questionForm');
		const iframe = document.getElementById('questionTable');

		form.addEventListener('submit', function (e) {
			e.preventDefault(); // Ngăn submit truyền thống

			const formData = new FormData(form);

			fetch('save_question.php', {
				method: 'POST',
				body: formData
			})
				.then(response => response.text())
				.then(result => {
					alert(result); // Hiển thị kết quả

					// Reset form
					form.reset();
					document.getElementById('imagePreview').style.display = 'none';
					document.getElementById('preview').innerHTML = '';

					// Làm mới bảng
					iframe.contentWindow.location.reload();
				})
				.catch(error => {
					alert('Lỗi khi gửi dữ liệu!');
					console.error('Error:', error);
				});
		});

	</script>
	<script>
		function syncTable() {
			const iframe = document.getElementById('questionTable');
			iframe.contentWindow.location.reload();         // Reload iframe
			iframe.scrollIntoView({ behavior: 'smooth' });  // Đưa con trỏ lên đầu
		}
	</script>

	<script>
		window.addEventListener('message', function (event) {
			const data = event.data;

			if (data && typeof data === 'object') {
				document.getElementById('question').value = data.question || '';
				document.querySelector('[name="answer1"]').value = data.answer1 || '';
				document.querySelector('[name="answer2"]').value = data.answer2 || '';
				document.querySelector('[name="answer3"]').value = data.answer3 || '';
				document.querySelector('[name="answer4"]').value = data.answer4 || '';
				document.querySelector('[name="correct_answer"]').value = data.correct_answer || '';

				// Hiển thị ảnh nếu có
				const imgPreview = document.getElementById('imagePreview');
				if (data.image) {
					imgPreview.src = data.image;
					imgPreview.style.display = 'block';
				} else {
					imgPreview.style.display = 'none';
				}

				// Hiển thị công thức nếu có
				document.getElementById('preview').innerHTML = data.question || '';
				MathJax.typesetPromise([document.getElementById('preview')]);
			}
		});
	</script>


</body>

</html>